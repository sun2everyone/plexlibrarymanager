<!DOCTYPE html>
<html>
    <head>
        <title>PlexLibraryManager by sun2</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/png" href="favicon.ico" />
        <?php
        //Dynamic CSS client refreshing
        if (file_exists('style.css')) {
            $css_last_modified = filectime('style.css');
        } else {
            $css_last_modified = '18112015';
        }
        ?>
<link href="style.css?ver=<?php echo $css_last_modified; ?>" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="md5.min.js"></script>
        <script type="text/javascript">
            function print_r(theObj){
               var html="";
              if(theObj.constructor == Array ||
                 theObj.constructor == Object){
                html+="<ul>";
                for(var p in theObj){
                  if(theObj[p].constructor == Array||
                     theObj[p].constructor == Object){
                    html+="<li>["+p+"] => "+typeof(theObj)+"</li>";
                    html+="<ul>";
                    print_r(theObj[p]);
                    html+="</ul>";
                  } else {
                    html+="<li>["+p+"] => "+theObj[p]+"</li>";
                  }
                }
                    html+="</ul>";
              }
              return html;
            }
            
            function showHide(element) {
              if ($(id).css('display') !== 'none') {
                  $(id).hide('slow');
              }  else {
                  $(id).show('slow');
              }
            }
            function getFolder(path,depth) {  
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php',
                    type: 'POST',
                    data: 'getfolder=' + path,
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                         //$('#folders').after('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                         $("div[name=\'" + path + "\'].folder").before('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.folders').before('<div class="error" onclick="$(this).remove();">' + json['error'] + '</div>');
                        } else {
                            if(json['folder']) {
                                depth+=1;
                                var parents_str=$("div[name=\'" + path + "\'].folder input[name=\'parents\']").attr('value');
                                parents_str+=' '+md5(path);
                                if(json['folder']['files'] != null) {
                                    var html="";
                                    //var child=$("div[name=\'" + path + "\'].folder").children().last();
                                   Object.keys(json['folder']['files']).forEach(function(key) { 
                                     var filename=json['folder']['files'][key]['name'];
                                     var filetype=json['folder']['files'][key]['type'];
                                         html+='<div class="file tr '+parents_str+'" name="'+path+'">';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="icon td"><img class="child" src="img/icon_'+filetype+'.png" style="padding-left:'+20*depth+'px;"></div>'
                                         html+='<div class="td" style="padding-left:'+20*depth+'px;">'+filename+'</div>';
                                         html+='</div>';
                                    });
                                    //child.after(html);
                                    $("div[name=\'" + path + "\'].folder").after(html);
                                }
                               if(json['folder']['subfolders'] != null) {
                                   var html="";
                                   json['folder']['subfolders'].forEach(function(entry) {
                                        var subpath=path + '/' + entry;
                                        html+='<div class="folder tr'+parents_str+'" name="'+subpath+'">';
                                        html+='<div class="option td"><input type="hidden" name="parents" value="'+parents_str+'">';
                                        html+='<input type="radio" name="src_folder_media" value="'+subpath+'"></div>';
                                        html+='<div class="td option"><input type="checkbox" name="src_folder_sub[]" value="'+subpath+'"></div>';
                                        html+='<div class="td option"><input type="checkbox" name="src_folder_audio[]" value="'+subpath+'"></div>';
                                        html+='<div class="icon td"><img class="child" src="img/icon_folder.png" style="padding-left:'+20*depth+'px;"></div>'
                                        html+='<div class="td" style="padding-left:'+20*depth+'px;" name="'+subpath+'" onclick="doExpand(\''+subpath+'\','+depth+')">'+entry+'</div>';
                                        html+='</div>';
                                         //child.after(html);
                                   }); 
                                   $("div[name=\'" + path + "\'].folder").after(html);
                                }
                                $("div[name=\'" + path + "\'].folder").addClass('expanded');
                                } 
                            }
                    },
                    error: function() {
                        alert("Some errors occured =(");
                    },
                    complete: function() {
                        $(".wait[name=\'" + path + "\']").remove();
                    },
                });
            }    
            function doExpand(folder,depth) {
                if(!$("div[name=\'" + folder + "\'].expanded").length) {
                 getFolder(folder,depth);
              } else {
                //$("div[name=\'" + folder + "\'].folder").children('.tr').remove();  
                $("div.tr."+md5(folder)).remove();
                $("div[name=\'" + folder + "\'].folder").removeClass('expanded');
              }
            }
            function parseFolder() {
                $('.error').remove();
               if($("input[name=\'src_folder_media\']:checked").length) {
                  $('form[name=\'parse_folder\']').submit();
               } else {
                  $('div.folders').before('<div class="error" onclick="$(this).remove();"><?php echo $strings['no_folder_selected']; ?></div>'); 
               }
            }
            
            function validateTitle(action) {
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php?action=validate_title'+action,
                    type: 'POST',
                    data: $('form[name=\'add_folder\']').serialize(),
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                        $('.warning').remove();
                        $('.status').remove();
                        $('.info').remove();
                        $("div.link.submit").remove();
                        $('div.link.validate').html("<?php echo($strings['add_to_lib']); ?>");
                         //$('#folders').after('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                         $("div.link.validate").after('<img class="wait status" name="title_validation" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.link.validate').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error']); ?>' + json['error'] + '</div>');
                        } else if (json['warning']) {
                            $('div.link.validate').before('<div class="warning" onclick="$(this).remove();"><?php echo($strings['warning']); ?>' + json['warning'] + '</div>');
                            $('div.link.validate').html("Проверить снова");
                            $('div.link.validate').after('<div class="link submit" onClick="validateTitle(\'_submit\');"><?php echo($strings['add_to_lib']); ?></div>');
                        } else if(json['status'] === "valid") {
                            validateTitle('_submit');
                        } else if(json['status'] !== "valid") {
                            $('div.link.validate').before('<div class="info" onclick="$(this).remove();">' + json['status'] + '</div>');
                            $('div.link.validate').after('<div class="link submit" onClick="document.location.href=\'<?php echo $hostname; ?>?mode=view\'"><?php echo($strings['view_library']); ?></div>');
                        } else {
                            alert("Some errors occured =(");
                        }
                    },
                    error: function() {
                        alert("Some errors occured =(");
                    },
                    complete: function() {
                        $(".wait").remove();
                    },
                }); 
            }
            
            function editTitle(id) {
                $("form[name=\'edit_title["+id+"]\']").submit();
            }
            function delTitle(id) {
                if( confirm("Уверены? Данное действие нельзя будет отменить!")) {
                    $("form[name=\'edit_title["+id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+id+"]\']").submit();
                }    
            }
            function editSeason(t_id,s_id) {
                $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                $("form[name=\'edit_title["+t_id+"]\']").submit();
            }
            function delSeason(t_id,s_id) {
                if( confirm("Уверены? Данное действие нельзя будет отменить!")) {
                    $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                    $("form[name=\'edit_title["+t_id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+t_id+"]\']").submit();
                }    
            }
            
        </script>
    </head>
    <body>
        <div id="content">
            <div><h1>Plex Library Manager</h1></div>
            <div class="small">
                <?php echo($strings['disclaimer']); ?>
                <?php echo($strings['path_to_root_media']); ?><?php echo $src_root_path; ?><br >
                <?php echo($strings['path_to_root_library']); ?><?php echo $plex_root_path; ?>
            </div>
            <div class="links">
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>'"><?php echo($strings['main_page']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=view'"><?php echo($strings['view_library']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'"><?php echo($strings['add_title']); ?></div>
            </div>    
            <?php if (isset($error)) { ?>
            <div class="error" onclick="$(this).remove();"><?php echo $error; ?></div>
            <?php } ?>
            <?php if (isset($status)) { ?>
            <div class="info" onclick="$(this).remove();"><?php echo $status; ?></div>
            <?php } ?>
            <?php if (isset($warning)) { ?>
            <div class="warning" onclick="$(this).remove();"><?php echo $warning; ?></div>
            <?php } ?>
            <div>
                <?php if ($mode == "add") { ?>
                <h2>Добавление файлов в библиотеку:</h2>
                Шаг 1. Отметьте подходящие папки:<br >
                <form name="parse_folder" method="post" action="index.php?mode=parse">
                <div class="folders">
                    <div class="theader tr">
                     <div class="td">Видео</div>
                     <div class="td">Сабы</div>
                     <div class="td">Озвучка</div>
                     <div class="td"></div>
                     <div class="td"></div>
                    </div>
                       <?php if(!empty($root_folder)) { 
                            foreach ($root_folder['subfolders'] as $subfolder) { 
                             $subfolder_path=$root_folder['path']."/".$subfolder;
                            ?> 
                            <div class="folder tr" name="<?php echo $subfolder_path; ?>">
                              <div class="option td"><input type="hidden" name="parents" value=""><input type="radio" name="src_folder_media" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option"><input type="checkbox" name="src_folder_sub[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option"><input type="checkbox" name="src_folder_audio[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="icon td"><img src="img/icon_folder.png"></div>
                              <div class="td" name="<?php echo $subfolder_path; ?>" onclick="doExpand('<?php echo $subfolder_path; ?>',0)"><?php echo $subfolder; ?></div>
                            </div>  
                            <?php } foreach ($root_folder['files'] as $file) { ?>
                            <div class="file tr">
                              <div class="option td"></div>
                              <div class="td option"></div>
                              <div class="td option"></div>
                              <div class="icon td"><img src="img/icon_<?php echo $file['type']; ?>.png"></div>
                              <div class="td"><?php echo $file['name']; ?></div>
                            </div>
                            <?php } ?>
                        <?php } ?>
                </div>
                </form>
                <div class="links">
                    <div class="link" onClick="parseFolder();">Автопарсинг</div>
                </div>    
                <?php } elseif ($mode == "parse") { ?>
                <h2>Добавление файлов в библиотеку:</h2>
                Шаг 2. Проверьте результат парсинга:<br>
                <div class="small">Выбранная директория c видео: <?php echo $src_folder_media; ?></div>
                    <?php if(isset($title_data)) { ?>
                    <form name="add_folder" method="post" action="index.php?mode=add">
                    <div class="title">
                        <div class="tr">
                            <div class="td">Предлагаемое имя:<br><div class="small">(Должно соответствовать TVDB/AniDB)</div></div>
                            <div class="td"><input type="text" name="title_data[name]" value="<?php echo $title_data['name']; ?>"></div>
                        </div>
                        <div class="tr">
                            <div class="td">Сезон:</div>
                            <div class="td"><select name="title_data[season]"><?php for($i=1; $i<=10; $i++) { ?><option><?php echo $i; ?></option><?php } ?></select></div>
                        </div>
                        <?php if(!empty($title_data['sub_folders'])) { ?>
                        <div class="tr">
                            <div class="td">Предпочитать субтитры из папки:</div>
                            <div class="td">
                                <?php foreach($title_data['sub_folders'] as $key=>$entry) { ?>
                                <input type="radio" name="title_data[pref_folder_sub]" value="<?php echo $entry; ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                        <?php if(!empty($title_data['aud_folders'])) { ?>
                        <div class="tr">
                            <div class="td">Предпочитать аудио из папки:</div>
                            <div class="td">
                                <?php foreach($title_data['aud_folders'] as $key=>$entry) { ?>
                                <input type="radio" name="title_data[pref_folder_aud]" value="<?php echo $entry; ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                    </div>
                    <?php if(!empty($title_data['episodes'])) { ?>
                    Список эпизодов: <br>
                    <div class="small">(Нажмите на нужное поле для редактирования)</div>
                    <div class="title episodes">
                        <div class="tr">
                           <div class="td">№:</div> 
                           <div class="td">Название:</div> 
                           <div class="td">Субтитры:</div> 
                           <div class="td">Озвучка:</div> 
                        </div>  
                        <?php foreach($title_data['episodes'] as $id=>$episode) { ?>
                        <div class="tr">
                            <div class="td"><?php echo $episode['id']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][id]" value="<?php echo $episode['id']; ?>"></div> 
                           <div class="td"><?php echo $episode['name']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][path]" value="<?php echo $episode['path']; ?>"></div> 
                           <div class="td">
                               <?php if(!empty($episode['sub'])) { ?>
                                Есть (<?php echo count($episode['sub']); ?>)
                                <?php foreach($episode['sub'] as $s_id=>$sub) { ?>
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][path]" value="<?php echo $sub['path']; ?>">
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][name]" value="<?php echo $sub['name']; ?>">
                                <?php } ?> 
                               <?php } else { ?>
                                Нет
                               <?php } ?>
                           </div> 
                           <div class="td">
                               <?php if(!empty($episode['aud'])) { ?>
                                Есть (<?php echo count($episode['aud']); ?>)
                                <?php foreach($episode['aud'] as $a_id=>$aud) { ?>
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][path]" value="<?php echo $aud['path']; ?>">
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][name]" value="<?php echo $aud['name']; ?>">
                                <?php } ?> 
                               <?php } else { ?>
                                Нет
                               <?php } ?>
                           </div> 
                        </div>  
                        <?php } ?>
                    </div>
                    <?php } ?>
                    </form>
                    <div class="links">
                        <div class="link validate" onClick="validateTitle('');">Добавить в библиотеку</div>
                    <?php } else { ?>
                        <div class="error" onclick="$(this).remove();">Ошибка! Попробуйте выбрать другую папку!</div>
                    <div class="links">
                    <?php } ?>
                       <div class="link" onClick="javascript:history.back(); return false;">Изменить выбор папок</div>
                    </div>   
                <?php } elseif ($mode == "view") { ?>
                <h2>Просмотр библиотеки:</h2>
                <div class="library">
                    <?php if(!empty($titles)) { 
                    $i=0;
                    foreach ($titles as $key=>$title) { $i++; ?>
                    <div class="tr">
                        <form name="edit_title[<?php echo $key?>]" method="post" action="index.php?mode=edit">
                        <div class="td">
                            <img src="img/icon_edit.png" onclick="editTitle('<?php echo $key?>');">
                            <img src="img/icon_delete.png" onclick="delTitle('<?php echo $key?>');">
                            <input type="hidden" name="title_name" value="<?php echo $title['name']; ?>">
                            <input type="hidden" name="season" value="0">
                        </div>
                        <div class="td title"><?php echo $i.". ".$title['name']; ?></div>
                        <div class="td">
                            <?php if(!empty($title['seasons'])) { ?>
                            <div class="small">
                                <ul>                               
                                <?php foreach ($title['seasons'] as $id=>$value) { ?>
                                    <li>Сезон <?php echo $id; ?>; Число эпизодов - <?php echo $value; ?> 
                                        <img src="img/icon_edit.png" onclick="editSeason('<?php echo $key?>','<?php echo $id?>');">
                                        <img src="img/icon_delete.png" onclick="delSeason('<?php echo $key?>','<?php echo $id?>');">
                                <?php } ?> 
                                </ul>
                            </div>   
                            <?php } ?>
                        </div>
                        </form>
                    </div>
                    <?php  }
                    } else { ?>
                    Библиотека пока пуста!
                    <?php } ?>
                </div>
                <div class="links">
                    <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'">Добавить новый тайтл</div>
                </div>  
                <?php } ?>
                
            </div>
        <br />
        </div>
        </body>
</html>
