<!DOCTYPE html>
<html>
    <head>
        <title>PlexLibraryManager by sun2</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/png" href="favicon.ico" />
        <?php
        //Dynamic CSS client refreshing
        if (file_exists('style.css')) {
            $css_last_modified = filectime('style.css');
        } else {
            $css_last_modified = '18112015';
        }
        ?>
<link href="style.css?ver=<?php echo $css_last_modified; ?>" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="md5.min.js"></script>
        <script type="text/javascript">

            function s_quotes(str) {
                str=str.replace(/&sq;/g,"'").replace(/&dq;/g,'"');
                return str;
            }
            function e_quotes(str) {
                str=str.replace(/"/g,"&dq;").replace(/'/g,"&sq;");
                return str;
            }
            
            function addFixedNavigation() { //If content overflow - add navigation bar at the bottom, else - del
                if ($(document).height() > $(window).innerHeight()) {
                            $('div.links.add, div.links.parse').addClass('overlay');
                            if(!$('div.links div.link.gotop').length) {
                                $('div.links.add, div.links.parse').children('.link').last().after('<div class="link gotop"><?php echo $strings['go_top']; ?></div>');
                            }    
                            $("#content").addClass('footerplace');
                        } else {
                            $("#content").removeClass('footerplace');
                            $('div.links.add, div.links.parse').removeClass('overlay');
                            $('div.links div.link.gotop').remove();
                        }
            }
            
            function getFolder(path,depth) {  
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php',
                    type: 'POST',
                    data: 'getfolder=' + encodeURIComponent(s_quotes(path)),
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                         $("div[name=\'" + path + "\'].folder").before('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.folders').before('<div class="error" onclick="$(this).remove();">' + json['error'] + '</div>');
                        } else {
                            if(json['folder']) {
                                depth+=1;
                                var parents_str=$("div[name=\'" + path + "\'].folder input[name=\'parents\']").attr('value');
                                parents_str+=' '+md5(path);
                                if(json['folder']['files'] != null) {
                                    var html="";
                                   Object.keys(json['folder']['files']).forEach(function(key) { 
                                     var filename=json['folder']['files'][key]['name'];
                                     var filetype=json['folder']['files'][key]['type'];
                                         html+='<div class="file tr '+parents_str+'" name="'+path+'">';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="icon td"><img class="child" src="img/icon_'+filetype+'.png" style="left:'+20*depth+'px;"></div>'
                                         html+='<div class="td filename '+filetype+'" style="left:'+20*depth+'px;">'+filename+'</div>';
                                         html+='</div>';
                                    });
                                    $("div[name=\'" + path + "\'].folder").after(html);
                                }
                               if(json['folder']['subfolders'] != null) {
                                   var html="";
                                   json['folder']['subfolders'].forEach(function(entry) {
                                        var subpath=path + '/' + entry;
                                        var e_subpath=e_quotes(subpath);
                                        html+='<div class="folder tr'+parents_str+'" name="'+e_subpath+'">';
                                        html+='<div class="option td" title="<?php echo($strings['th_vid']); ?>" style="left:'+20*depth+'px;"><input type="hidden" name="parents" value="'+parents_str+'">';
                                        html+='<input class="ajax_loaded" type="radio" name="src_folder_media" value="'+e_subpath+'"></div>';
                                        html+='<div class="td option" title="<?php echo($strings['th_sub']); ?>" style="left:'+20*depth+'px;"><input class="ajax_loaded" type="checkbox" name="src_folder_sub[]" value="'+e_subpath+'"></div>';
                                        html+='<div class="td option" title="<?php echo($strings['th_aud']); ?>" style="left:'+20*depth+'px;" ><input class="ajax_loaded" type="checkbox" name="src_folder_audio[]" value="'+e_subpath+'"></div>';
                                        html+='<div class="icon td" style="left:'+20*depth+'px;"><img class="child" src="img/icon_folder.png"></div>'
                                        html+='<div class="td folder-link" style="left:'+20*depth+'px;" name="'+e_subpath+'" onclick="doExpand(\''+e_subpath+'\','+depth+')">'+entry+'</div>';
                                        html+='</div>';
                                   }); 
                                   //Automated scrolling when opening folder
                                   $("div[name=\'" + path + "\'].folder").after(html);
                                   if ($(document).height() > $(window).innerHeight()) {
                                       var y=window.scrollY+$(window).innerHeight(); //current bottom position
                                       if ($("div"+parents_str.replace(/ /g,'.')).length) {
                                            var offset=$("div"+parents_str.replace(/ /g,'.')).last().offset().top+100;
                                            if (offset >= y) { //children overflow
                                                var len=$("div"+parents_str.replace(/ /g,'.')).last().offset().top+100-$("div[name=\'" + path + "\'].folder").offset().top;
                                                if (len >= $(window).innerHeight()) { //big folder, more than screen
                                                    offset=$("div[name=\'" + path + "\'].folder").offset().top-10; //parent folder to the top
                                                } else {
                                                    offset=offset-$(window).innerHeight();
                                                }
                                                $("html,body").animate({"scrollTop":offset},"slow");
                                            }
                                       } 
                                   }
                                   
                                }
                                $("div[name=\'" + path + "\'].folder").addClass('expanded');
                                } 
                                addFixedNavigation();
                                $("form.add_folder div.media-edit").trigger('change');
                            }
                    },
                    error: function() {
                        alert("Some errors occured on server side =(");
                    },
                    complete: function() {
                        $(".wait[name=\'" + path + "\']").remove();
                    },
                });
            }    
            function doExpand(folder,depth) {
              if(!$("div[name=\'" + folder + "\'].expanded").length) {
                 getFolder(folder,depth);
              } else { 
                $("div.tr."+md5(folder)).remove();
                $("div[name=\'" + folder + "\'].folder").removeClass('expanded');
                addFixedNavigation(); //Collapse
              }
            }
            function parseFolder() {
                $('.error').remove();
               if($("input[name=\'src_folder_media\']:checked").length) {
                  $('form[name=\'parse_folder\']').submit();
               } else {
                  $('div.folders').before('<div class="error" onclick="$(this).remove();"><?php echo $strings['no_folder_selected']; ?></div>'); 
               }
            }
            
            function validateTitle(action) {
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php?action=validate_title'+action,
                    type: 'POST',
                    data: $('form[name=\'add_folder\']').serialize(),
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                        $('.warning').remove();
                        $('.status').remove();
                        $('.info').remove();
                        $("div.link.submit").remove();
                        $('div.link.validate').html("<?php echo($strings['add_to_lib']); ?>");
                         $("div.link.validate").after('<img class="wait status" name="title_validation" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.link.validate').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error']); ?>' + json['error'] + '</div>');
                        } else if (json['warning']) {
                            $('div.link.validate').before('<div class="warning" onclick="$(this).remove();"><?php echo($strings['warning']); ?>' + json['warning'] + '</div>');
                            $('div.link.validate').html("Проверить снова");
                            $('div.link.validate').after('<div class="link submit" onClick="validateTitle(\'_submit\');"><?php echo($strings['add_to_lib']); ?></div>');
                        } else if(json['status'] === "valid") {
                            validateTitle('_submit');
                        } else if(json['status'] !== "valid") {
                            $('div.link.validate').before('<div class="info" onclick="$(this).remove();">' + json['status'] + '</div>');
                            $('div.link.validate').after('<div class="link submit" onClick="document.location.href=\'<?php echo $hostname; ?>?mode=view\'"><?php echo($strings['view_library']); ?></div>');
                        } else {
                            alert("Some errors occured =(");
                        }
                    },
                    error: function() {
                        alert("Some errors occured on server side =( Check your php_errors.log");
                    },
                    complete: function() {
                        $(".wait").remove();
                    },
                }); 
            }
            
            function editTitle(id) {
                $("form[name=\'edit_title["+id+"]\']").submit();
            }
            function delTitle(id) {
                if( confirm("<?php echo $strings['confirmation']; ?>")) {
                    $("form[name=\'edit_title["+id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+id+"]\']").submit();
                }    
            }
            function editSeason(t_id,s_id) {
                $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                $("form[name=\'edit_title["+t_id+"]\']").submit();
            }
            function delSeason(t_id,s_id) {
                if( confirm("<?php echo $strings['confirmation']; ?>")) {
                    $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                    $("form[name=\'edit_title["+t_id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+t_id+"]\']").submit();
                }    
            }
            
            function episodes_sort() { //Episodes table sorting
                $('.episodes div.tr.episode').each(function(index,element) {
                    var val=parseInt($(this).find('.ep-id input').prop('value'),10);
                     $('.episodes div.tr.episode').each(function(index2,element2) {
                        var c_val=parseInt($(this).find('.ep-id input').prop('value'),10);
                        if ((val > c_val) && (index < index2)) {
                           $(element2).after(element);
                        } 
                     });
                });
            }
            
            function shortPath(path) {
                //Short-path to display in div
                var short_path=path.replace(/<?php echo addcslashes($src_root_path,'^$.*+?=!:|\/()[]{}-'); ?>/,"");
                if (short_path.length>102) { 
                    short_path="..."+short_path.substr(short_path.length-102);
                }
                return short_path;
            }
            
            
            //Bindings
            $(function(){
                    //Nice highlighted checkboxes with background clicking
                    $('div.folders, div.episodes').on("click", "div.option.td", function(){
                        $(this).children('input:checkbox, input:radio').prop("checked",!$(this).children('input:checkbox').prop('checked'));
                        $(this).children('input:checkbox').trigger("change");
                    });
                    $('div.folders, div.episodes').on("click", "div.option.td input:checkbox", function(){
                        $(this).prop("checked",!$(this).prop('checked'));
                    });    
                    $('div.episodes input[name=\'select_all_episodes\']').on("change", function() {
                        $('div.episodes input:checkbox').prop("checked",$(this).prop('checked'));
                    });
                    //Fixed buttons
                    $(window).on("load",function() { 
                        addFixedNavigation();
                    });
                    $('div.links').on("click", "div.link.gotop", function(){
                       $("html,body").animate({"scrollTop":0},"slow");
                    });
                    ////////////////////////////////////////////////////////
                    ////Episode id editing
                    $('div.episodes').on("click", "div.ep-id", function(e) {
                        $('.error').remove();
                        var hidden_name=$(this).find('input[type=\'hidden\']').attr('name');
                        var hidden_id=$(this).find('input[type=\'hidden\']').prop('value');
                        var html='<input type="text" value="" maxlength="3"><input type="hidden" name="'+hidden_name+'" value="'+hidden_id+'">';
                        $(this).html(html);
                        $(this).children('input').focus();
                        $(this).children('input').on("change click keyup input paste", function(event) { //filtering input
                            var val=$(this).prop('value');
                            //checking val
                            val=val.replace(/[^0-9]/g,'');
                            //  
                            $(this).prop('value',val);
                            if(event.keyCode == 13){
                                $(this).trigger('focusout');
                            }
                        });
                        $(this).children('input').on("focusout", function() {
                            var val=$(this).prop('value');
                            //checking val
                            val=parseInt(val.replace(/[^0-9]/g,''),10);
                            //
                            if ((val !== "") && (val>0) && (val<999) && (val !== 'undefined')) {
                                if($("div.episodes div.ep-id input[value='"+val+"']:hidden").length) {
                                    $(this).parent().addClass("failed");
                                    $('div.title.episodes').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error'].$strings['err_ep_id']); ?></div>');
                                    val=hidden_id;
                                }  
                            } else {
                               $(this).parent().addClass("failed");
                               $('div.title.episodes').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error'].$strings['err_ep_id']); ?></div>'); 
                               val=hidden_id;
                            }
                            $(this).parent().html(val+'<input type="hidden" name="'+hidden_name+'" value="'+val+'">');
                            setTimeout(function(){ $("div.episodes div.ep-id").removeClass('failed');},500);
                        });
                    });
                    ///////////////////////////////////////////////////////////////
                    //Episode external media editing dialogue
                    $('div.episodes .episode').on("click", "img.edit", function() {
                        if ($(this).hasClass('sub')) { //selecting action -subs or audio
                            var targt="sub";
                        } else {
                            var targt="aud";
                        }
                        //creating base dialogue layer
                        var html='<img class="close" src="img/icon_close.png">'; //Buttons to add if empty sub-data
                        var ep_id=parseInt($(this).parents('.episode').find('input.episodes').prop('value'),10); //Episode system id remembering
                        $(this).parents('.'+targt).find('.'+targt+'-data').each(function(index,element) { //loading existing media data
                            var path=$(this).find('input.'+targt+'-path').prop('value');
                            var md_str=md5(path);
                            var sub_name=$(this).find('input.'+targt+'-path').attr('name');
                            var namestr=$(this).find('input.'+targt+'-name').prop('value');
                            var namestr_name=$(this).find('input.'+targt+'-name').attr('name');
                            var short_path=shortPath(s_quotes(path));
                            html+='<div class="'+targt+'-data '+md_str+'"><div class="input-text">'+short_path+'</div>';
                            html+='<input type="hidden" class="'+targt+'-path" name="'+sub_name+'" value="'+path+'">';
                            html+='<input type="hidden" class="'+targt+'-name" name="'+namestr_name+'" value="'+namestr+'">';
                            html+='<div class="actions"><img class="delete" src="img/icon_delete.png" title="<?php echo $strings['del']; ?>"></div></div>';
                        });
                        html+='<div class="actions final"><img class="add" src="img/icon_add.png" title="<?php echo $strings['add']; ?>"><img class="submit" src="img/icon_submit.png" title="<?php echo $strings['submit']; ?>"></div>';
                        if (html !== "") { //filling layer with data
                            $('div.media-edit').html(html);
                            var div_h=$('div.media-edit-container').height();
                            var y=window.scrollY;
                            if (div_h > $(window).innerHeight()) {
                                y=y+50;
                            } else {
                               y=y+parseInt(($(window).innerHeight()-div_h)/2, 10); 
                            }
                            $('div.media-edit-container').css({'top': +y+'px'});
                            $('div.media-edit-container').show();
                        ///
                        //Adding js functions to buttons
                            src_obj=$(this).parents('.'+targt);
                            $("form.add_folder div.media-edit").on("click", "img.submit", function() {
                                src_obj.trigger('submit');
                                $('form.add_folder div.media-edit-container').hide();
                                $('.warning').remove();
                                $("form.add_folder div.media-edit").off("click", "img.submit");
                                addFixedNavigation();
                            });
                        }
                        $("form.add_folder div.media-edit").off("click", "img.delete"); //Delete media entry
                        $("form.add_folder div.media-edit").on("click", "img.delete", function() {
                                $(this).parents('div.'+targt+'-data').remove();
                        });
                        $("form.add_folder div.media-edit").off("click", "img.add"); //Add media entry
                        $("form.add_folder div.media-edit").on("click", "img.add", function() {
                            if (!$('form.add_folder div.media-edit .filemanager').length) { //create filemanager layer
                                html='<div class="filemanager"><?php echo $strings['select_file']; ?>';
                                html+='<div class="folders">';
                                var basefolder=e_quotes('<?php echo addcslashes($src_root_path,"'"); ?>');
                                html+='<div class="folder tr" name="'+basefolder+'" style="display:hidden;"><input type="hidden" name="parents" value=""></div>';
                                html+='</div></div>';
                                $(this).parent().before(html);
                                $(this).attr('src','img/icon_delete.png');
                                getFolder(basefolder,0);
                            } else {
                                $('form.add_folder div.media-edit .filemanager').remove();
                                $(this).attr('src','img/icon_add.png');
                            }    
                        });
                        $("form.add_folder div.media-edit").off("change"); //trigger from getFolder() to choose what type of files will be addable
                        $("form.add_folder div.media-edit").on("change", function() {
                            $(this).find('.filename.'+targt).addClass('selectable');
                        });
                        $('div.episodes .episode .'+targt).off("submit");
                        $('div.episodes .episode .'+targt).on("submit", function() { //Copying new subtitle data to main form
                           $(this).children('div:first-child').html("");
                           $("form.add_folder div.media-edit div."+targt+"-data").find('.input-text, .actions').remove();
                           $(this).children('div:first-child').html($("form.add_folder div.media-edit ."+targt+"-data"));
                           count=$(this).find('.'+targt+'-data').length;
                           var html=$(this).html();
                           if (count>0) {
                              $(this).find('.'+targt+'-data:first-child').before("<?php echo($strings['entry_yes']); ?> ("+count+")"); 
                           } else {
                              $(this).find('div:first-child').html("<?php echo($strings['entry_no']); ?>"); 
                           } 
                           //Copying new media_priority to main form
                           $(this).find('div.'+targt+'-data input.'+targt+'-name').each(function() {
                               var namestr=$(this).prop('value');
                               //create table place if not exist
                               if(!$('.add_folder .title .pref-'+targt).length) {
                                   if (targt == 'sub') {
                                    var str='<?php echo($strings['th_pref_sub']); ?>';
                                   } else { 
                                    var str='<?php echo($strings['th_pref_aud']); ?>';
                                   } 
                                   var html='<div class="tr pref-'+targt+'"><div class="td">'+str+'</div><div class="td"><div><input type="radio" name="title_data[pref_folder_'+targt+']" value="'+namestr+'" checked>'+s_quotes(namestr)+'<br></div></div></div>'
                                   $('.add_folder .title .tr.season').after(html);
                               } 
                               if (!$('input[name=\'title_data[pref_folder_'+targt+']\'][value=\''+namestr+'\']').length) {
                                   if(!$('.add_folder .title .pref-'+targt+' input:checked').length) {
                                       var checked=" checked";
                                   } else {
                                       var checked="";
                                   }
                                   var html=$('.add_folder .title .pref-'+targt+' div.td:last').html()+'<div><input type="radio" name="title_data[pref_folder_'+targt+']" value="'+namestr+'"'+checked+'>'+s_quotes(namestr)+'<br></div>';
                                   $('.add_folder .title .pref-'+targt+' div.td:last').html(html);
                               } 
                           });
                            //Remove unnecessary radio buttons
                           $('.add_folder .title .pref-'+targt+' input').each(function() {
                               if(!$('div.episodes .episode input.'+targt+'-name[value=\''+$(this).prop('value')+'\']').length) {
                                   $(this).parent('div').remove();
                               }
                           });
                           ///
                        });
                        $("form.add_folder div.media-edit").off("click",".filename.selectable"); //adding media entry
                        $("form.add_folder div.media-edit").on("click",".filename.selectable", function() {
                           var filename=$(this).html();
                           var path=$(this).parents('.file.tr').attr('name');
                           var src=path+"/"+filename;
                               src=e_quotes(src);
                           var md_str=md5(src);
                           if(!$("form.add_folder div.media-edit ."+targt+"-data."+md_str).length) { //checking if duplicate
                               var short_path=shortPath(s_quotes(src));
                               var html="";
                               //getting previous ID and episode ID
                               if ($("form.add_folder div.media-edit ."+targt+"-data").length) {
                                   var prev_name=$("form.add_folder div.media-edit ."+targt+"-data:last").find('input.'+targt+'-path').attr('name');
                                   var arr=prev_name.split("]["+targt+"][");
                                   var sub_id = parseInt(arr[1].replace(/\D*/g,""),10)+1;
                               } else {
                                  var sub_id=0;
                               }
                               //Getting dir name to be able to set priority, as in functions.php>addMediaRecursive()
                               if (path === '<?php echo (isset($src_folder_media) ? e_quotes($src_folder_media) : ""); ?>') {
                                   path=path.replace(/^.*\//,"");
                               } else {
                                   path=path.replace(/<?php echo addcslashes((isset($src_folder_media) ? e_quotes($src_folder_media) : ""),'^$.*+?=!:|\/()[]{}-'); ?>\//,"");
                               }
                               path=path.replace(/<?php echo addcslashes($src_root_path,'^$.*+?=!:|\/()[]{}-'); ?>\//,"");
                               var namestr=path;
                               
                               var arr=filename.split(".");
                               if (arr.length>2) { //if filename complex, like title.[something-else].dumb.ass
                                   var i=1;
                                   namestr+=" ";
                                   while ((i<(arr.length-1)) && (i<10)) {
                                    namestr+=arr[i];   
                                    i++;
                                    if (i<(arr.length-1)) {
                                      namestr+=".";  
                                    }
                                   }
                               }
                               namestr=e_quotes(namestr);
                               //
                               html+='<div class="'+targt+'-data '+md_str+'"><div class="input-text">'+short_path+'</div>';
                               html+='<input type="hidden" class="'+targt+'-path" name="title_data[episodes]['+ep_id+']['+targt+']['+sub_id+'][path]" value="'+src+'">';
                               html+='<input type="hidden" class="'+targt+'-name" name="title_data[episodes]['+ep_id+']['+targt+']['+sub_id+'][name]" value="'+namestr+'">';
                               html+='<div class="actions"><img class="delete" src="img/icon_delete.png" title="<?php echo $strings['del']; ?>"></div></div>';
                               $("form.add_folder div.media-edit .filemanager").before(html);
                               $("form.add_folder div.media-edit img.add").attr('src','img/icon_add.png');
                               $("form.add_folder div.media-edit .filemanager").remove();
                            } else { //duplicate
                               $('div.title.episodes').before('<div class="warning" onclick="$(this).remove();"><?php echo $strings['err_file_already_added']; ?></div>');
                            }
                        });
                    });
                    $("form.add_folder div.media-edit").on("click", "img.close", function() {
                        $('.media-edit-container').hide();
                        $('.warning').remove();
                        addFixedNavigation();
                    });
                });
            
        </script>
    </head>
    <body>
        <div id="content">
            <div><h1>Plex Library Manager</h1></div>
            <div class="small">
                <?php echo($strings['disclaimer']); ?>
                <?php echo($strings['path_to_root_media']); ?><?php echo $src_root_path; ?><br >
                <?php echo($strings['path_to_root_library']); ?><?php echo $plex_root_path; ?>
            </div>
            <div class="links">
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>'"><?php echo($strings['main_page']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=view'"><?php echo($strings['view_library']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'"><?php echo($strings['add_title']); ?></div>
            </div>    
            <?php if (isset($error)) { ?>
            <div class="error" onclick="$(this).remove();"><?php echo $error; ?></div>
            <?php } ?>
            <?php if (isset($status)) { ?>
            <div class="info" onclick="$(this).remove();"><?php echo $status; ?></div>
            <?php } ?>
            <?php if (isset($warning)) { ?>
            <div class="warning" onclick="$(this).remove();"><?php echo $warning; ?></div>
            <?php } ?>
            <div>
                <?php if ($mode == "add") { ?>
                <h2><?php echo($strings['header_add_title']); ?></h2>
                <?php echo($strings['header_select_folders']); ?><br >
                <form name="parse_folder" method="post" action="index.php?mode=parse">
                    <div class="settings">
                      <h3><?php echo $strings['settings']; ?></h3>  
                      <input type="checkbox" name="guess_ep_numbers" value="1" checked><?php echo $strings['guess_ep_numbers']; ?></br>
                      <div class="small"><?php echo $strings['guess_ep_numbers_hint']; ?></div>
                    </div>   
                <div class="folders">
                    <div class="theader tr">
                     <div class="td"><?php echo($strings['th_vid']); ?></div>
                     <div class="td"><?php echo($strings['th_sub']); ?></div>
                     <div class="td"><?php echo($strings['th_aud']); ?></div>
                     <div class="td"></div>
                     <div class="td"></div>
                    </div>
                       <?php if(!empty($root_folder)) { 
                            foreach ($root_folder['subfolders'] as $subfolder) { 
                             $subfolder_path=$root_folder['path']."/".$subfolder;
                             $subfolder_path=e_quotes($subfolder_path);
                            ?> 
                            <div class="folder tr" name="<?php echo $subfolder_path; ?>">
                                <div class="option td" title="<?php echo($strings['th_vid']); ?>"><input type="hidden" name="parents" value=""><input type="radio" name="src_folder_media" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option" title="<?php echo($strings['th_sub']); ?>"><input type="checkbox" name="src_folder_sub[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option" title="<?php echo($strings['th_aud']); ?>"><input type="checkbox" name="src_folder_audio[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="icon td"><img src="img/icon_folder.png"></div>
                              <div class="td folder-link" name="<?php echo $subfolder_path; ?>" onclick="doExpand('<?php echo $subfolder_path; ?>',0)"><?php echo $subfolder; ?></div>
                            </div>  
                            <?php } foreach ($root_folder['files'] as $file) { ?>
                            <div class="file tr">
                              <div class="option td"></div>
                              <div class="td option"></div>
                              <div class="td option"></div>
                              <div class="icon td"><img src="img/icon_<?php echo $file['type']; ?>.png"></div>
                              <div class="td"><?php echo $file['name']; ?></div>
                            </div>
                            <?php } ?>
                        <?php } ?>
                </div>
                </form>
                <div class="links parse">
                    <div class="link" onClick="parseFolder();"><?php echo($strings['autoparsing']); ?></div>
                    <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=view'"><?php echo($strings['view_library']); ?></div>
                </div>    
                <?php } elseif ($mode == "parse") { ?>
                <h2><?php echo($strings['header_add_title']); ?></h2>
                <?php echo($strings['header_check_parsing']); ?>
                <br>
                <div class="small"><?php echo($strings['video_folder_selected']); ?><?php echo $src_folder_media; ?></div>
                    <?php if(isset($title_data)) { ?>
                    <form name="add_folder" class="add_folder" method="post" action="index.php?mode=add">
                    <div class="title">
                        <div class="tr">
                            <div class="td"><?php echo($strings['suggested_name']); ?><br><div class="small"><?php echo($strings['tvdb']); ?></div></div>
                            <div class="td"><input type="text" name="title_data[name]" value="<?php echo str_replace('"','&quot;',$title_data['name']); ?>" maxlength="100"></div>
                        </div>
                        <div class="tr season">
                            <div class="td"><?php echo($strings['th_season']); ?></div>
                            <div class="td"><select name="title_data[season]"><?php for($i=1; $i<=10; $i++) { ?><option <?php if ($i == $title_data['season_num']) echo "selected"; ?>><?php echo $i; ?></option><?php } ?><option value="0"><?php echo $strings['special'];?></option></select></div>
                        </div>
                        <?php if(!empty($title_data['sub_folders'])) { ?>
                        <div class="tr pref-sub">
                            <div class="td"><?php echo($strings['th_pref_sub']); ?></div>
                            <div class="td">
                                <?php foreach($title_data['sub_folders'] as $key=>$entry) { ?>
                                <div><input type="radio" name="title_data[pref_folder_sub]" value="<?php echo e_quotes($entry); ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br></div>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                        <?php if(!empty($title_data['aud_folders'])) { ?>
                        <div class="tr pref-aud">
                            <div class="td"><?php echo($strings['th_pref_aud']); ?></div>
                            <div class="td">
                                <?php foreach($title_data['aud_folders'] as $key=>$entry) { ?>
                                <div><input type="radio" name="title_data[pref_folder_aud]" value="<?php echo e_quotes($entry); ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br></div>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                    </div>
                    <?php if(!empty($title_data['episodes'])) { ?>
                    <?php echo($strings['th_ep_list']); ?><br>
                    <div class="small"><?php echo($strings['edit_field']); ?></div>
                    <div class="media-edit-container" style="display:none;">
                        <div class="media-edit"></div>
                    </div>    
                    <div class="title episodes">
                        <div class="tr theader">
                           <div class="option td"><input type="checkbox" name="select_all_episodes" value="" checked></div>
                           <div class="td ep-id-header"><div>№</div><div><img title="<?php echo $strings['sort']; ?>" src="img/icon_asc_num.png" onClick="episodes_sort();"></div></div> 
                           <div class="td"><?php echo($strings['th_title']); ?></div> 
                           <div class="td"><?php echo($strings['th_sub']); ?></div> 
                           <div class="td"><?php echo($strings['th_aud']); ?></div> 
                        </div>  
                        <?php foreach($title_data['episodes'] as $id=>$episode) { ?>
                        <div class="tr episode">
                            <div class="option td"><input type="checkbox" class="episodes" name="title_data[use_episodes][]" value="<?php echo $id?>" checked></div>
                            <div class="td ep-id" title="<?php echo $strings['change']; ?>"><?php echo $episode['id']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][id]" value="<?php echo $episode['id']; ?>"></div> 
                           <div class="td ep-title"><?php echo $episode['name']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][path]" value="<?php echo e_quotes($episode['path']); ?>"></div> 
                           <div class="td sub">
                               <div>
                                   <?php if(!empty($episode['sub'])) { ?>
                                   <?php echo($strings['entry_yes']); ?> (<?php echo count($episode['sub']); ?>)
                                    <?php foreach($episode['sub'] as $s_id=>$sub) { ?>
                                    <div class="sub-data">    
                                    <input type="hidden" class="sub-path" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][path]" value="<?php echo e_quotes($sub['path']); ?>">
                                    <input type="hidden" class="sub-name" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][name]" value="<?php echo e_quotes($sub['name']); ?>">
                                    </div>
                                    <?php } ?> 
                                   <?php } else { ?>
                                    <?php echo($strings['entry_no']); ?>
                                   <?php } ?>
                               </div>
                               <div>
                                <img class="edit sub" src="img/icon_edit.png" title="<?php echo $strings['change']; ?>">
                               </div>
                           </div> 
                           <div class="td aud">
                               <div>
                                   <?php if(!empty($episode['aud'])) { ?>
                                    <?php echo($strings['entry_yes']); ?> (<?php echo count($episode['aud']); ?>)
                                    <?php foreach($episode['aud'] as $a_id=>$aud) { ?>
                                    <div class="aud-data"> 
                                    <input type="hidden" class="aud-path" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][path]" value="<?php echo e_quotes($aud['path']); ?>">
                                    <input type="hidden" class="aud-name" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][name]" value="<?php echo e_quotes($aud['name']); ?>">
                                    </div>
                                    <?php } ?> 
                                   <?php } else { ?>
                                    <?php echo($strings['entry_no']); ?>
                                   <?php } ?>
                               </div>
                               <div>
                                <img class="edit aud" src="img/icon_edit.png" title="<?php echo $strings['change']; ?>">
                               </div>
                           </div> 
                        </div>  
                        <?php } ?>
                    </div>
                    <?php } ?>
                    </form>
                    <div class="links add">
                        <div class="link validate" onClick="validateTitle('');"><?php echo($strings['add_to_lib']); ?></div>
                    <?php } else { ?>
                        <div class="error" onclick="$(this).remove();"><?php echo($strings['err_try_another']); ?></div>
                    <div class="links add">
                    <?php } ?>
                       <div class="link" onClick="javascript:history.back(); return false;"><?php echo($strings['ch_folder_sel']); ?></div>
                    </div>   
                <?php } elseif ($mode == "view") { ?>
                <h2><?php echo($strings['header_view_lib']); ?></h2>
                <div class="library">
                    <?php if(!empty($titles)) { 
                    $i=0;
                    foreach ($titles as $key=>$title) { $i++; ?>
                    <div class="tr">
                        <form name="edit_title[<?php echo $key?>]" method="post" action="index.php?mode=edit">
                        <div class="td">
                            <img class="edit" src="img/icon_edit.png" onclick="editTitle('<?php echo $key?>');" title="<?php echo $strings['change']; ?>">
                            <img src="img/icon_delete.png" onclick="delTitle('<?php echo $key?>');" title="<?php echo $strings['del']; ?>">
                            <input type="hidden" name="title_name" value="<?php echo $title['name']; ?>">
                            <input type="hidden" name="season" value="0">
                        </div>
                        <div class="td title"><?php echo $i.". ".$title['name']; ?></div>
                        <div class="td seasons">
                            <?php if(!empty($title['seasons'])) { ?>
                            <div class="small">                         
                                <?php foreach ($title['seasons'] as $id=>$value) { ?>
                                    <div><?php echo sprintf($strings['title_seasons'],$id,$value); ?> </div>
                                <?php } ?> 
                            </div>   
                            <?php } ?>
                        </div>
                        <div class="td manage">
                            <?php if(!empty($title['seasons'])) { ?>
                            <div class="small">
                                <?php foreach ($title['seasons'] as $id=>$value) { ?>
                                <div>
                                        <img class="edit" src="img/icon_edit.png" onclick="editSeason('<?php echo $key?>','<?php echo $id?>');" title="<?php echo $strings['change']; ?>">
                                        <img src="img/icon_delete.png" onclick="delSeason('<?php echo $key?>','<?php echo $id?>');" title="<?php echo $strings['del']; ?>">
                                </div>        
                                <?php } ?> 
                            </div>   
                            <?php } ?>
                        </div>    
                        </form>
                    </div>
                    <?php  }
                    } else { ?>
                        <?php echo($strings['lib_empty']); ?>
                    <?php } ?>
                </div>
                <div class="links add">
                    <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'"><?php echo($strings['add_title']); ?></div>
                </div>  
                <?php } ?>
                
            </div>
        <br />
        </div>
        </body>
</html>
