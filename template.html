<!DOCTYPE html>
<html>
    <head>
        <title>PlexLibraryManager by sun2</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/png" href="favicon.ico" />
        <?php
        //Dynamic CSS client refreshing
        if (file_exists('style.css')) {
            $css_last_modified = filectime('style.css');
        } else {
            $css_last_modified = '18112015';
        }
        ?>
<link href="style.css?ver=<?php echo $css_last_modified; ?>" rel="stylesheet" type="text/css" />
        <script type="text/javascript" src="jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="md5.min.js"></script>
        <script type="text/javascript">
            function print_r(theObj){
               var html="";
              if(theObj.constructor == Array ||
                 theObj.constructor == Object){
                html+="<ul>";
                for(var p in theObj){
                  if(theObj[p].constructor == Array||
                     theObj[p].constructor == Object){
                    html+="<li>["+p+"] => "+typeof(theObj)+"</li>";
                    html+="<ul>";
                    print_r(theObj[p]);
                    html+="</ul>";
                  } else {
                    html+="<li>["+p+"] => "+theObj[p]+"</li>";
                  }
                }
                    html+="</ul>";
              }
              return html;
            }
            
            function showHide(element) {
              if ($(id).css('display') !== 'none') {
                  $(id).hide('slow');
              }  else {
                  $(id).show('slow');
              }
            }
            function getFolder(path,depth) {  
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php',
                    type: 'POST',
                    data: 'getfolder=' + path,
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                         //$('#folders').after('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                         $("div[name=\'" + path + "\'].folder").before('<img class="wait status" name="' + path +'" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.folders').before('<div class="error" onclick="$(this).remove();">' + json['error'] + '</div>');
                        } else {
                            if(json['folder']) {
                                depth+=1;
                                var parents_str=$("div[name=\'" + path + "\'].folder input[name=\'parents\']").attr('value');
                                parents_str+=' '+md5(path);
                                if(json['folder']['files'] != null) {
                                    var html="";
                                    //var child=$("div[name=\'" + path + "\'].folder").children().last();
                                   Object.keys(json['folder']['files']).forEach(function(key) { 
                                     var filename=json['folder']['files'][key]['name'];
                                     var filetype=json['folder']['files'][key]['type'];
                                         html+='<div class="file tr '+parents_str+'" name="'+path+'">';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="option td"></div>';
                                         html+='<div class="icon td"><img class="child" src="img/icon_'+filetype+'.png" style="left:'+20*depth+'px;"></div>'
                                         html+='<div class="td" style="padding-left:'+20*depth+'px;">'+filename+'</div>';
                                         html+='</div>';
                                    });
                                    //child.after(html);
                                    $("div[name=\'" + path + "\'].folder").after(html);
                                }
                               if(json['folder']['subfolders'] != null) {
                                   var html="";
                                   json['folder']['subfolders'].forEach(function(entry) {
                                        var subpath=path + '/' + entry;
                                        html+='<div class="folder tr'+parents_str+'" name="'+subpath+'">';
                                        html+='<div class="option td" title="<?php echo($strings['th_vid']); ?>" style="left:'+20*depth+'px;"><input type="hidden" name="parents" value="'+parents_str+'">';
                                        html+='<input class="ajax_loaded" type="radio" name="src_folder_media" value="'+subpath+'"></div>';
                                        html+='<div class="td option" title="<?php echo($strings['th_sub']); ?>" style="left:'+20*depth+'px;"><input class="ajax_loaded" type="checkbox" name="src_folder_sub[]" value="'+subpath+'"></div>';
                                        html+='<div class="td option" title="<?php echo($strings['th_aud']); ?>" style="left:'+20*depth+'px;" ><input class="ajax_loaded" type="checkbox" name="src_folder_audio[]" value="'+subpath+'"></div>';
                                        html+='<div class="icon td" style="left:'+20*depth+'px;"><img class="child" src="img/icon_folder.png"></div>'
                                        html+='<div class="td folder-link" style="left:'+20*depth+'px;" name="'+subpath+'" onclick="doExpand(\''+subpath+'\','+depth+')">'+entry+'</div>';
                                        html+='</div>';
                                         //child.after(html);
                                   }); 
                                   //Automated scrolling when opening folder
                                   $("div[name=\'" + path + "\'].folder").after(html);
                                   if ($(document).height() > $(window).innerHeight()) {
                                       var y=window.scrollY+$(window).innerHeight(); //current bottom position
                                       if ($("div"+parents_str.replace(/ /g,'.')).length) {
                                            var offset=$("div"+parents_str.replace(/ /g,'.')).last().offset().top+100;
                                            if (offset >= y) { //children overflow
                                                var len=$("div"+parents_str.replace(/ /g,'.')).last().offset().top+100-$("div[name=\'" + path + "\'].folder").offset().top;
                                                if (len >= $(window).innerHeight()) { //big folder, more than screen
                                                    offset=$("div[name=\'" + path + "\'].folder").offset().top-10; //parent folder to the top
                                                } else {
                                                    offset=offset-$(window).innerHeight();
                                                }
                                                $("html,body").animate({"scrollTop":offset},"slow");
                                            }
                                       } 
                                   }
                                   
                                }
                                $("div[name=\'" + path + "\'].folder").addClass('expanded');
                                } 
                            }
                    },
                    error: function() {
                        alert("Some errors occured =(");
                    },
                    complete: function() {
                        $(".wait[name=\'" + path + "\']").remove();
                    },
                });
            }    
            function doExpand(folder,depth) {
                if(!$("div[name=\'" + folder + "\'].expanded").length) {
                 getFolder(folder,depth);
              } else {
                //$("div[name=\'" + folder + "\'].folder").children('.tr').remove();  
                $("div.tr."+md5(folder)).remove();
                $("div[name=\'" + folder + "\'].folder").removeClass('expanded');
              }
            }
            function parseFolder() {
                $('.error').remove();
               if($("input[name=\'src_folder_media\']:checked").length) {
                  $('form[name=\'parse_folder\']').submit();
               } else {
                  $('div.folders').before('<div class="error" onclick="$(this).remove();"><?php echo $strings['no_folder_selected']; ?></div>'); 
               }
            }
            
            function validateTitle(action) {
               $.ajax({
                    url: '<?php echo $hostname; ?>index.php?action=validate_title'+action,
                    type: 'POST',
                    data: $('form[name=\'add_folder\']').serialize(),
                    dataType: 'json',
                    beforeSend: function() {
                        $('.error').remove();
                        $('.warning').remove();
                        $('.status').remove();
                        $('.info').remove();
                        $("div.link.submit").remove();
                        $('div.link.validate').html("<?php echo($strings['add_to_lib']); ?>");
                         $("div.link.validate").after('<img class="wait status" name="title_validation" src="img/loader.gif">');
                    },
                    success: function(json){
                        if (json['error']) {
                            $('div.link.validate').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error']); ?>' + json['error'] + '</div>');
                        } else if (json['warning']) {
                            $('div.link.validate').before('<div class="warning" onclick="$(this).remove();"><?php echo($strings['warning']); ?>' + json['warning'] + '</div>');
                            $('div.link.validate').html("Проверить снова");
                            $('div.link.validate').after('<div class="link submit" onClick="validateTitle(\'_submit\');"><?php echo($strings['add_to_lib']); ?></div>');
                        } else if(json['status'] === "valid") {
                            validateTitle('_submit');
                        } else if(json['status'] !== "valid") {
                            $('div.link.validate').before('<div class="info" onclick="$(this).remove();">' + json['status'] + '</div>');
                            $('div.link.validate').after('<div class="link submit" onClick="document.location.href=\'<?php echo $hostname; ?>?mode=view\'"><?php echo($strings['view_library']); ?></div>');
                        } else {
                            alert("Some errors occured =(");
                        }
                    },
                    error: function() {
                        alert("Some errors occured on server side =( Check your php_errors.log");
                    },
                    complete: function() {
                        $(".wait").remove();
                    },
                }); 
            }
            
            function editTitle(id) {
                $("form[name=\'edit_title["+id+"]\']").submit();
            }
            function delTitle(id) {
                if( confirm("<?php echo $strings['confirmation']; ?>")) {
                    $("form[name=\'edit_title["+id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+id+"]\']").submit();
                }    
            }
            function editSeason(t_id,s_id) {
                $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                $("form[name=\'edit_title["+t_id+"]\']").submit();
            }
            function delSeason(t_id,s_id) {
                if( confirm("<?php echo $strings['confirmation']; ?>")) {
                    $("form[name=\'edit_title["+t_id+"]\'] input[name=\'season\']").attr("value",s_id);
                    $("form[name=\'edit_title["+t_id+"]\']").attr("action","index.php?mode=del")
                    $("form[name=\'edit_title["+t_id+"]\']").submit();
                }    
            }
            
            //Bindings
            $(function(){
                    //Nice highlighted checkboxes with background clicking
                    $('div.folders, div.episodes').on("click", "div.option.td", function(){
                        $(this).children('input:checkbox, input:radio').prop("checked",!$(this).children('input:checkbox').prop('checked'));
                        $(this).children('input:checkbox').trigger("change");
                    });
                    $('div.folders, div.episodes').on("click", "div.option.td input:checkbox", function(){
                        $(this).prop("checked",!$(this).prop('checked'));
                    });    
                    $('div.episodes input[name=\'select_all_episodes\']').on("change", function() {
                        $('div.episodes input:checkbox').prop("checked",$(this).prop('checked'));
                    });
                    //Fixed buttons
                    $(window).on("load",function() { 
                        if ($(document).height() > $(window).innerHeight()) {
                            $('div.links.add, div.links.parse').addClass('overlay');
                            $('div.links.add, div.links.parse').children('.link').last().after('<div class="link gotop"><?php echo $strings['go_top']; ?></div>');
                            $("#content").addClass('footerplace');
                        }
                    });
                    $('div.links').on("click", "div.link.gotop", function(){
                       $("html,body").animate({"scrollTop":0},"slow");
                    });
                    //Episode id editing
                    $('div.episodes').on("click", "div.ep-id", function(e) {
                        var hidden_name=$(this).children('input').attr('name');
                        var hidden_id=$(this).children('input').prop('value');
                        var html='<input type="text" value="" maxlength="3">';
                        $(this).html(html);
                        $(this).children('input').focus();
                        $(this).children('input').on("change click keyup input paste", function(event) { //filtering input
                            var val=$(this).prop('value');
                            //checking val
                            val=val.replace(/[^0-9]/g,'');
                            //  
                            $(this).prop('value',val);
                            if(event.keyCode == 13){
                                $(this).trigger('focusout');
                            }
                        });
                        $(this).children('input').on("focusout", function() {
                            var val=$(this).prop('value');
                            //checking val
                            val=val.replace(/[^0-9]/g,'');
                            //
                            if ((val !== "") && (val>0) && (val<999)) {
                                if($("div.episodes div.ep-id input[value='"+val+"']:hidden").length) {
                                    $(this).parent().addClass("failed");
                                    $('div.title.episodes').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error'].$strings['err_ep_id']); ?></div>');
                                    val=hidden_id;
                                }  
                            } else {
                               $(this).parent().addClass("failed");
                               $('div.title.episodes').before('<div class="error" onclick="$(this).remove();"><?php echo($strings['error'].$strings['err_ep_id']); ?></div>'); 
                               val=hidden_id;
                            }
                            $(this).parent().html(val+'<input type="hidden" name="'+hidden_name+'" value="'+val+'">');
                            setTimeout(function(){ $("div.episodes div.ep-id").removeClass('failed');},500);
                        });
                    });    
                });
            
        </script>
    </head>
    <body>
        <div id="content">
            <div><h1>Plex Library Manager</h1></div>
            <div class="small">
                <?php echo($strings['disclaimer']); ?>
                <?php echo($strings['path_to_root_media']); ?><?php echo $src_root_path; ?><br >
                <?php echo($strings['path_to_root_library']); ?><?php echo $plex_root_path; ?>
            </div>
            <div class="links">
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>'"><?php echo($strings['main_page']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=view'"><?php echo($strings['view_library']); ?></div>
                <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'"><?php echo($strings['add_title']); ?></div>
            </div>    
            <?php if (isset($error)) { ?>
            <div class="error" onclick="$(this).remove();"><?php echo $error; ?></div>
            <?php } ?>
            <?php if (isset($status)) { ?>
            <div class="info" onclick="$(this).remove();"><?php echo $status; ?></div>
            <?php } ?>
            <?php if (isset($warning)) { ?>
            <div class="warning" onclick="$(this).remove();"><?php echo $warning; ?></div>
            <?php } ?>
            <div>
                <?php if ($mode == "add") { ?>
                <h2><?php echo($strings['header_add_title']); ?></h2>
                <?php echo($strings['header_select_folders']); ?><br >
                <form name="parse_folder" method="post" action="index.php?mode=parse">
                <div class="folders">
                    <div class="theader tr">
                     <div class="td"><?php echo($strings['th_vid']); ?></div>
                     <div class="td"><?php echo($strings['th_sub']); ?></div>
                     <div class="td"><?php echo($strings['th_aud']); ?></div>
                     <div class="td"></div>
                     <div class="td"></div>
                    </div>
                       <?php if(!empty($root_folder)) { 
                            foreach ($root_folder['subfolders'] as $subfolder) { 
                             $subfolder_path=$root_folder['path']."/".$subfolder;
                            ?> 
                            <div class="folder tr" name="<?php echo $subfolder_path; ?>">
                                <div class="option td" title="<?php echo($strings['th_vid']); ?>"><input type="hidden" name="parents" value=""><input type="radio" name="src_folder_media" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option" title="<?php echo($strings['th_sub']); ?>"><input type="checkbox" name="src_folder_sub[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="td option" title="<?php echo($strings['th_aud']); ?>"><input type="checkbox" name="src_folder_audio[]" value="<?php echo $subfolder_path; ?>"></div>
                              <div class="icon td"><img src="img/icon_folder.png"></div>
                              <div class="td folder-link" name="<?php echo $subfolder_path; ?>" onclick="doExpand('<?php echo $subfolder_path; ?>',0)"><?php echo $subfolder; ?></div>
                            </div>  
                            <?php } foreach ($root_folder['files'] as $file) { ?>
                            <div class="file tr">
                              <div class="option td"></div>
                              <div class="td option"></div>
                              <div class="td option"></div>
                              <div class="icon td"><img src="img/icon_<?php echo $file['type']; ?>.png"></div>
                              <div class="td"><?php echo $file['name']; ?></div>
                            </div>
                            <?php } ?>
                        <?php } ?>
                </div>
                </form>
                <div class="links parse">
                    <div class="link" onClick="parseFolder();"><?php echo($strings['autoparsing']); ?></div>
                    <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=view'"><?php echo($strings['view_library']); ?></div>
                </div>    
                <?php } elseif ($mode == "parse") { ?>
                <h2><?php echo($strings['header_add_title']); ?></h2>
                <?php echo($strings['header_check_parsing']); ?>
                <br>
                <div class="small"><?php echo($strings['video_folder_selected']); ?><?php echo $src_folder_media; ?></div>
                    <?php if(isset($title_data)) { ?>
                    <form name="add_folder" class="add_folder" method="post" action="index.php?mode=add">
                    <div class="title">
                        <div class="tr">
                            <div class="td"><?php echo($strings['suggested_name']); ?><br><div class="small"><?php echo($strings['tvdb']); ?></div></div>
                            <div class="td"><input type="text" name="title_data[name]" value="<?php echo $title_data['name']; ?>"></div>
                        </div>
                        <div class="tr">
                            <div class="td"><?php echo($strings['th_season']); ?></div>
                            <div class="td"><select name="title_data[season]"><?php for($i=1; $i<=10; $i++) { ?><option <?php if ($i == $title_data['season_num']) echo "selected"; ?>><?php echo $i; ?></option><?php } ?></select></div>
                        </div>
                        <?php if(!empty($title_data['sub_folders'])) { ?>
                        <div class="tr">
                            <div class="td"><?php echo($strings['th_pref_sub']); ?></div>
                            <div class="td">
                                <?php foreach($title_data['sub_folders'] as $key=>$entry) { ?>
                                <input type="radio" name="title_data[pref_folder_sub]" value="<?php echo $entry; ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                        <?php if(!empty($title_data['aud_folders'])) { ?>
                        <div class="tr">
                            <div class="td"><?php echo($strings['th_pref_aud']); ?></div>
                            <div class="td">
                                <?php foreach($title_data['aud_folders'] as $key=>$entry) { ?>
                                <input type="radio" name="title_data[pref_folder_aud]" value="<?php echo $entry; ?>" <?php echo($key == 0 ? "checked" : "" ); ?>><?php echo $entry; ?><br>
                                <?php } ?>
                            </div>
                        </div>
                        <?php } ?>
                    </div>
                    <?php if(!empty($title_data['episodes'])) { ?>
                    <?php echo($strings['th_ep_list']); ?><br>
                    <div class="small"><?php echo($strings['edit_field']); ?></div>
                    <div class="title episodes">
                        <div class="tr theader">
                           <div class="option td"><input type="checkbox" name="select_all_episodes" value="" checked></div>
                           <div class="td">№</div> 
                           <div class="td"><?php echo($strings['th_title']); ?></div> 
                           <div class="td"><?php echo($strings['th_sub']); ?></div> 
                           <div class="td"><?php echo($strings['th_aud']); ?></div> 
                        </div>  
                        <?php foreach($title_data['episodes'] as $id=>$episode) { ?>
                        <div class="tr episode">
                            <div class="option td"><input type="checkbox" class="episodes" name="title_data[use_episodes][]" value="<?php echo $id?>" checked></div>
                            <div class="td ep-id" title="<?php echo $strings['change']; ?>"><?php echo $episode['id']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][id]" value="<?php echo $episode['id']; ?>"></div> 
                           <div class="td ep-title"><?php echo $episode['name']; ?><input type="hidden" name="title_data[episodes][<?php echo $id?>][path]" value="<?php echo $episode['path']; ?>"></div> 
                           <div class="td">
                               <?php if(!empty($episode['sub'])) { ?>
                                <?php echo($strings['entry_yes']); ?> (<?php echo count($episode['sub']); ?>)
                                <?php foreach($episode['sub'] as $s_id=>$sub) { ?>
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][path]" value="<?php echo $sub['path']; ?>">
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][sub][<?php echo $s_id; ?>][name]" value="<?php echo $sub['name']; ?>">
                                <?php } ?> 
                               <?php } else { ?>
                                <?php echo($strings['entry_no']); ?>
                               <?php } ?>
                           </div> 
                           <div class="td">
                               <?php if(!empty($episode['aud'])) { ?>
                                <?php echo($strings['entry_yes']); ?> (<?php echo count($episode['aud']); ?>)
                                <?php foreach($episode['aud'] as $a_id=>$aud) { ?>
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][path]" value="<?php echo $aud['path']; ?>">
                                <input type="hidden" name="title_data[episodes][<?php echo $id; ?>][aud][<?php echo $a_id; ?>][name]" value="<?php echo $aud['name']; ?>">
                                <?php } ?> 
                               <?php } else { ?>
                                <?php echo($strings['entry_no']); ?>
                               <?php } ?>
                           </div> 
                        </div>  
                        <?php } ?>
                    </div>
                    <?php } ?>
                    </form>
                    <div class="links add">
                        <div class="link validate" onClick="validateTitle('');"><?php echo($strings['add_to_lib']); ?></div>
                    <?php } else { ?>
                        <div class="error" onclick="$(this).remove();"><?php echo($strings['err_try_another']); ?></div>
                    <div class="links add">
                    <?php } ?>
                       <div class="link" onClick="javascript:history.back(); return false;"><?php echo($strings['ch_folder_sel']); ?></div>
                    </div>   
                <?php } elseif ($mode == "view") { ?>
                <h2><?php echo($strings['header_view_lib']); ?></h2>
                <div class="library">
                    <?php if(!empty($titles)) { 
                    $i=0;
                    foreach ($titles as $key=>$title) { $i++; ?>
                    <div class="tr">
                        <form name="edit_title[<?php echo $key?>]" method="post" action="index.php?mode=edit">
                        <div class="td">
                            <img src="img/icon_edit.png" onclick="editTitle('<?php echo $key?>');">
                            <img src="img/icon_delete.png" onclick="delTitle('<?php echo $key?>');">
                            <input type="hidden" name="title_name" value="<?php echo $title['name']; ?>">
                            <input type="hidden" name="season" value="0">
                        </div>
                        <div class="td title"><?php echo $i.". ".$title['name']; ?></div>
                        <div class="td">
                            <?php if(!empty($title['seasons'])) { ?>
                            <div class="small">
                                <ul>                               
                                <?php foreach ($title['seasons'] as $id=>$value) { ?>
                                    <li><?php echo sprintf($strings['title_seasons'],$id,$value); ?> 
                                        <img src="img/icon_edit.png" onclick="editSeason('<?php echo $key?>','<?php echo $id?>');">
                                        <img src="img/icon_delete.png" onclick="delSeason('<?php echo $key?>','<?php echo $id?>');">
                                <?php } ?> 
                                </ul>
                            </div>   
                            <?php } ?>
                        </div>
                        </form>
                    </div>
                    <?php  }
                    } else { ?>
                        <?php echo($strings['lib_empty']); ?>
                    <?php } ?>
                </div>
                <div class="links add">
                    <div class="link" onClick="document.location.href='<?php echo $hostname; ?>?mode=add'"><?php echo($strings['add_title']); ?></div>
                </div>  
                <?php } ?>
                
            </div>
        <br />
        </div>
        </body>
</html>
